# Story 4.1: Workout Planning Service Integration APIs

## Status
Draft

## Story

**As a** workout management system,
**I want** seamless integration with external workout planning service that creates and manages single active workout plans per user,
**so that** I can retrieve personalized workout plans, associate them with users through activePlans records, and ensure each user has exactly one modifiable workout plan.

## Acceptance Criteria

1. **Single Workout Plan Creation**: Endpoint (`POST /api/integrations/workout-plans`) that creates one workout plan per user via external service and updates user's `activePlans.workoutPlanId` with the new plan ID
2. **Single Plan Enforcement**: System ensures each user has exactly one active workout plan by deactivating previous plans before creating new ones
3. **Workout Plan Caching**: Store received plans in MongoDB with user association through `activePlans` record, including expiration and refresh mechanisms
4. **Daily Workout Access**: Endpoint (`GET /api/workouts/daily`) returning user's single active workout plan with real-time machine availability integration
5. **Workout Library**: Endpoint (`GET /api/workouts/library`) aggregating external service data with local customization options
6. **External Service Integration**: Error handling with circuit breaker pattern and fallback to user's cached active workout plan
7. **Plan Refresh Management**: Automated refresh mechanism that regenerates workout plans every 2 weeks based on current user parameters, maintaining single active plan per user
8. **Data Validation**: Service response validation ensuring workout data integrity before storage and user association
9. **Automated Plan Management**: Fully automated workout plan creation and storage without user modification capabilities
10. **Active Plans Maintenance**: Proper management of user's `activePlans.workoutPlanId` reference with cleanup of inactive plans

## Tasks / Subtasks

- [ ] **Task 1: Create External Workout Planning Service Integration** (AC: 1, 8, 10)
  - [ ] Create `src/services/external/workout-planning.service.ts` with external API client
  - [ ] Implement request authentication using API Key from external-apis.config.ts
  - [ ] Add request timeout handling (30 seconds per coding standards)
  - [ ] Implement service response validation with Joi schemas
  - [ ] Add Winston logging for all external API calls with context
  - [ ] Implement single plan creation logic with user association
  - [ ] Add activePlans record update functionality

- [ ] **Task 2: Implement Single Workout Plan Caching System** (AC: 2, 3, 6)
  - [ ] Extend workoutPlans MongoDB collection to include cache metadata and user association
  - [ ] Add caching fields: `cacheExpiry`, `lastRefreshed`, `source: 'external'`, `userId`, `nextRefreshDate`
  - [ ] Implement single plan enforcement: deactivate existing plans before creating new ones
  - [ ] Implement Redis caching layer with `cache:` prefix for quick access
  - [ ] Create 2-week refresh cycle tracking with nextRefreshDate calculation
  - [ ] Add circuit breaker pattern for external service failures with fallback to user's active plan

- [ ] **Task 3: Create Integration Controller Endpoints** (AC: 1, 9, 10)
  - [ ] Create `src/controllers/integrations.controller.ts`
  - [ ] Implement `POST /api/integrations/workout-plans` endpoint with automated single plan creation
  - [ ] Add Joi validation for user profile data input
  - [ ] Implement JWT authentication middleware
  - [ ] Implement automated activePlans record management in controller layer

- [ ] **Task 4: Enhance Workout Controllers** (AC: 4, 5)
  - [ ] Update `src/controllers/workouts.controller.ts` 
  - [ ] Implement `GET /api/workouts/daily` returning user's single active workout plan
  - [ ] Implement `GET /api/workouts/library` endpoint
  - [ ] Add real-time machine availability from branches collection
  - [ ] Integrate user's active workout plan with machine availability
  - [ ] Add user authentication to ensure access to own active plan only

- [ ] **Task 5: Create Integration Routes** (AC: 1, 3, 4, 8)
  - [ ] Create `src/routes/integrations.routes.ts`
  - [ ] Mount integration routes in `src/app.ts`
  - [ ] Apply rate limiting middleware (external API usage optimization)
  - [ ] Add request logging middleware

- [ ] **Task 6: Implement Automated Plan Refresh System** (AC: 7, 10)
  - [ ] Create background job in `src/jobs/workout-plan-refresh.job.ts` with 2-week schedule
  - [ ] Implement single plan replacement logic during automated refresh
  - [ ] Add cron job configuration for bi-weekly execution (every 14 days)
  - [ ] Fetch current user parameters (fitness profile, demographics) during refresh
  - [ ] Add system-initiated refresh capability maintaining single plan rule
  - [ ] Ensure activePlans record consistency during refresh operations
  - [ ] Add plan generation timestamp tracking for refresh scheduling

- [ ] **Task 7: Add Configuration and Environment** (AC: 1, 5, 7)
  - [ ] Update `src/config/external-apis.config.ts` with workout service configuration
  - [ ] Add environment variables for API keys and timeouts
  - [ ] Configure rate limiting and retry logic parameters
  - [ ] Add circuit breaker configuration settings

- [ ] **Task 8: Unit and Integration Tests** (Testing Standards)
  - [ ] Create unit tests for workout-planning.service.ts (85% coverage requirement)
  - [ ] Create integration tests for workout endpoints in `tests/integration/api/`
  - [ ] Mock external service responses using Jest mocks
  - [ ] Test error handling and fallback mechanisms
  - [ ] Test caching behavior and expiration logic

## Dev Notes

### Previous Story Insights
From Story 2.4 (Access Control Fixes):
- Authentication middleware patterns established with `requireUserOrAdmin()` and `isUserAdmin()` helpers
- Dual access patterns (user/admin) successfully implemented for user data access
- JWT validation patterns and error response formats are standardized
- Ownership validation patterns available for user-specific resources

### Data Models
**workoutPlans Collection** [Source: database-schema.md#workoutPlans]:
- Structure: `{ userId, planName, isActive, workoutDays: [{ muscleGroup, categories: [{ exercises }] }] }`
- Relationships: Referenced by users.activePlans.workoutPlanId
- Indexes: `userId + isActive` for efficient user plan queries

**users Collection Extensions** [Source: data-models.md#users]:
- `fitnessProfile`: `{ level, goal, healthConditions }` - Required for external service API calls
- `demographics`: `{ age, heightCm, weightKg, activityLevel }` - User profile data for personalized plans
- `activePlans.workoutPlanId` - References current workout plan

**branches Collection for Machine Availability** [Source: data-models.md#branches]:
- `machines` array with `isAvailable` field for real-time availability
- Machine metadata: `{ name, type, location, qrCode, isAvailable }`

### API Specifications
**External Workout Planning Service** [Source: external-apis.md#workout-planning-service-api]:
- Base URL: `https://api.workout-service.com/v1`
- Authentication: API Key authentication via headers
- Rate Limits: 1000 requests per hour per API key
- Key Endpoints:
  - `POST /plans/generate` - Generate personalized workout plan
  - `GET /exercises/library` - Retrieve exercise database
  - `POST /plans/customize` - Modify existing workout plans
- Integration Notes: Retry logic with exponential backoff, cache responses for 24 hours, fallback to cached plans

### Component Specifications
**Service Layer** [Source: source-tree.md#services]:
- Location: `src/services/external/workout-planning.service.ts`
- Pattern: Business logic layer with external API integration
- Dependencies: axios HTTP client, winston logger, joi validation

**Controller Layer** [Source: source-tree.md#controllers]:
- Location: `src/controllers/integrations.controller.ts`
- Pattern: HTTP request handlers with middleware chain
- Dependencies: JWT authentication, Joi validation, Winston logging

**Routes Layer** [Source: source-tree.md#routes]:
- Location: `src/routes/integrations.routes.ts`
- Pattern: Express route definitions with middleware
- Integration: Mount in `src/app.ts` as `/api/integrations`

### File Locations
**Core Implementation Files** [Source: source-tree.md]:
- Service: `src/services/external/workout-planning.service.ts`
- Controller: `src/controllers/integrations.controller.ts` (new file)
- Routes: `src/routes/integrations.routes.ts` (new file)
- Background Job: `src/jobs/workout-plan-refresh.job.ts` (new file)
- Configuration: `src/config/external-apis.config.ts` (extend existing)

**Existing Files to Modify**:
- `src/controllers/workouts.controller.ts` - Add daily/library endpoints
- `src/services/users.service.ts` - Add refresh triggers on goal changes
- `src/services/analytics.service.ts` - Add refresh triggers on performance updates
- `src/app.ts` - Mount integration routes

### Testing Requirements
**Test Strategy** [Source: test-strategy-and-standards.md]:
- Framework: Jest 29.7.0 with TypeScript support
- Unit Tests: 85% coverage requirement for service layer
- File Convention: `*.test.ts` co-located with source files
- Mocking: Jest built-in mocking with manual mocks for external services

**Integration Testing**:
- Location: `tests/integration/` directory
- External APIs: WireMock for stubbing external service responses
- Database: TestContainers with isolated test database
- Coverage: API endpoint testing with real database connections

### Technical Constraints
**Coding Standards** [Source: coding-standards.md]:
- Async/await only - no callbacks or raw Promises
- All API endpoints must use Joi validation schemas
- All catch blocks must log errors with Winston logger context
- External HTTP calls must have explicit timeouts (30 seconds)
- Redis keys must use consistent prefixes (`cache:` for caching)

**Technology Stack** [Source: tech-stack.md]:
- HTTP Client: axios 1.6.2 for external service integration
- Caching: Redis 7.2 for in-memory caching with session management
- Database: MongoDB 7.0 with Mongoose 8.0.3 ODM
- Validation: Joi 17.11.0 for input validation and sanitization
- Rate Limiting: express-rate-limit 7.1.5 for API protection

### Testing

**Unit Test Requirements**:
- Test file location: Co-located `*.test.ts` files with source
- Coverage requirement: 85% minimum for service layer, 75% for controllers
- Testing framework: Jest 29.7.0 with TypeScript support
- Mock external dependencies including external APIs and database
- Follow AAA pattern (Arrange, Act, Assert) for test structure

**Integration Test Requirements**:
- Location: `tests/integration/api/` directory for API endpoint testing
- Use TestContainers for isolated MongoDB test database
- Use WireMock for stubbing external service responses
- Test complete API workflows with real database connections

**Specific Test Cases to Implement**:
- External service integration with success/failure scenarios
- Caching behavior and expiration logic
- Circuit breaker pattern functionality
- Rate limiting and retry mechanisms
- Workout plan refresh trigger mechanisms
- Machine availability integration
- Error handling and fallback to cached plans

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-21 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by the QA Agent after story implementation*